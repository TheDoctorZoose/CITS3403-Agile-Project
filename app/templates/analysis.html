{% extends "base.html" %}

{% block title %}Analysis View{% endblock %}

{% block extra_styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/analysis-styles.css') }}">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
{% endblock %}

{% block body_class %}analysis-page{% endblock %}

{% block content %}
<main class="container">
  <section class="left-column">

    <!-- Summary -->
    <div id="summary">
      <h2 id="summary-header">At a glance...</h2>
      <div id="summary-columns">
        <div class="summary-column">
          <p id="plays">Plays: <span>{{ plays }}</span></p>
          <p id="players">Players: <span>{{ players }}</span></p>
          <p id="h-index">H-index: <span>{{ h_index }}</span></p>
          <p class="h-index-note">
            <span>{{ h_index }}</span> games were played at least <span>{{ h_index }}</span> times
          </p>
        </div>
        <div class="summary-column">
          <p id="games">Games: <span>{{ games }}</span></p>
          <p id="days">Days: <span>{{ days }}</span></p>
        </div>
      </div>
    </div>

    <hr class="section-divider">

    <!-- Create New Analysis -->
    <div class="card create-card">
      <h3>Create New Analysis View</h3>
      <form action="/save-view" method="POST">
        <!-- ... 保持不变 … -->
      </form>
    </div>

    <hr class="section-divider">

    <!-- Charts Grid -->
    <div class="cards-grid">
      <div class="card">
        <h3>Plays Per Month</h3>
        <canvas id="plays-per-month-chart"></canvas>
      </div>
      <div class="card">
        <h3>Top 5 Most Played Games</h3>
        <canvas id="top-games-chart"></canvas>
      </div>
      <div class="card">
        <h3>Player Leaderboard</h3>
        <canvas id="leaderboard-chart"></canvas>
      </div>
      <div class="card">
        <h3>First Play Success Rate</h3>
        <canvas id="first-play-chart"></canvas>
      </div>
    </div>
  </section>
</main>
{% endblock %}

{% block extra_scripts %}
<script>
  // 注入后端数据
  window.playsPerMonth  = {{ plays_per_month  | tojson }};
  window.topGames       = {{ top_games       | tojson }};
  window.leaderboard    = {{ leaderboard     | tojson }};
  window.firstPlayStats = {{ first_play_stats | tojson }};

  document.addEventListener('DOMContentLoaded', function() {
    // 1) Plays Per Month
    new Chart(
      document.getElementById('plays-per-month-chart').getContext('2d'),
      {
        type: 'line',
        data: {
          labels: window.playsPerMonth.map(r=>`${r.year}-${String(r.month).padStart(2,'0')}`),
          datasets: [{ label:'Plays', data: window.playsPerMonth.map(r=>r.count), fill:true }]
        }
      }
    );

    // 2) Top Games
    new Chart(
      document.getElementById('top-games-chart').getContext('2d'),
      {
        type:'bar',
        data:{
          labels: window.topGames.map(r=>r.game),
          datasets:[{ label:'Plays', data: window.topGames.map(r=>r.count) }]
        }
      }
    );

    // 3) Leaderboard (Win %)
    new Chart(
      document.getElementById('leaderboard-chart').getContext('2d'),
      {
        type:'bar',
        data:{
          labels: window.leaderboard.map(r=>r.username),
          datasets:[{ label:'Win %', data: window.leaderboard.map(r=>r.win_rate) }]
        },
        options:{
          scales:{ y:{ beginAtZero:true, max:100 } }
        }
      }
    );

    // 4) First Play Success Rate (Doughnut)
    new Chart(
      document.getElementById('first-play-chart').getContext('2d'),
      {
        type:'doughnut',
        data:{
          labels:['Wins','Losses'],
          datasets:[{
            label:'First Play',
            data:[
              window.firstPlayStats.wins,
              window.firstPlayStats.total - window.firstPlayStats.wins
            ]
          }]
        }
      }
    );

  });
</script>
{% endblock %}
