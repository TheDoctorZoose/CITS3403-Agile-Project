{% extends "base.html" %}

{% block title %}Board Game Entry Analysis Tool{% endblock %}

{% block extra_styles %}
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Ëá™ÂÆö‰πâË¶ÜÁõñÊ†∑Âºè -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/upload-data.css') }}">
{% endblock %}

{% block body_class %}upload-data-page{% endblock %}

{% block content %}
<div class="container my-4">
  <h1 class="text-center">Upload Data</h1>
  <p class="text-center">Please fill in the form below to record your board game session.</p>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="alert-container">
        {% for category, message in messages %}
          <div class="alert alert-{{ 'success' if category == 'message' else category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- CSV Upload -->
  <section class="file-upload">
    <h2 class="h5 mb-3">Import CSV into Form</h2>
    <input type="file" id="csvInput" class="form-control" accept=".csv">
    <button type="button" id="loadCsvBtn" class="btn btn-primary mt-3">Load CSV to Form</button>
  </section>

  <!-- Manual Data Entry -->
  <section aria-label="Manual Data Entry" class="mt-5">
    <h2 class="h5 text-center">Manual Data Entry</h2>

    <form id="entryForm" action="{{ url_for('main.forum') }}" method="POST">
      <!-- ÂèØËßÅÊÄßÈÄâÊã© -->
      <fieldset class="visibility-section">
        <legend class="fw-semibold">Who can see this entry?</legend>

        <div class="visibility-row">
          <label for="visibility" class="visibility-label">Visibility:</label>
          <select id="visibility" name="visibility" class="form-select visibility-select">
            <option value="public">Everyone</option>
            <option value="friends">Only selected friends</option>
          </select>
        </div>

        <div id="friend-selection" class="friend-selection">
          {% if friends %}
            <p class="mt-3 mb-2 fw-semibold">Select friends allowed to view:</p>
            <div class="friend-checkboxes">
              {% for friend in friends %}
                <div class="friend-checkbox-row form-check">
                  <input class="form-check-input" type="checkbox" name="allowed_users" value="{{ friend.id }}" id="friend{{ friend.id }}">
                  <label class="form-check-label" for="friend{{ friend.id }}">
                    {{ friend.username }}
                  </label>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <p class="text-muted">You have no friends to share with.</p>
          {% endif %}
        </div>
      </fieldset>

      <!-- Ê∏∏ÊàèÂü∫Êú¨‰ø°ÊÅØ -->
      <div class="mb-3">
        <label for="gameTitle" class="form-label">Game Title:</label>
        <input type="text" id="gameTitle" name="gameTitle" class="form-control" required placeholder="e.g., Go">
      </div>

      <div class="mb-3">
        <label for="datePlayed" class="form-label">Date Played:</label>
        <input type="date" id="datePlayed" name="datePlayed" class="form-control" required>
      </div>

      <!-- Áé©ÂÆ∂‰ø°ÊÅØ -->
      <div id="playersContainer">
        <fieldset class="player-info">
          <legend class="fw-semibold">Player 1 (You)</legend>

          <div class="mb-3">
            <label for="player1Name" class="form-label">Name:</label>
            <input type="text" id="player1Name" name="player1Name" class="form-control" required placeholder="Player Name">
          </div>

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="player1Win" name="player1Win">
            <label class="form-check-label" for="player1Win">Win?</label>
          </div>
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="player1First" name="player1First">
            <label class="form-check-label" for="player1First">Went First?</label>
          </div>
          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="player1FirstTime" name="player1FirstTime">
            <label class="form-check-label" for="player1FirstTime">First Time Playing?</label>
          </div>

          <label for="player1Score" class="form-label">Score:</label>
          <input type="number" id="player1Score" name="player1Score" class="form-control" placeholder="e.g., 30">
        </fieldset>
      </div>

      <div id="playerButtons" class="mb-4">
        <button type="button" id="addPlayerBtn" class="btn btn-outline-secondary">+ Add Another Player</button>
      </div>

      <div class="submit-buttons">
        <button type="submit" class="btn btn-success">Submit Entry</button>
        <button type="submit" class="btn btn-info">Submit and Share</button>
      </div>
    </form>
  </section>

  <!-- Submitted Entries -->
  <section id="entryDisplay" aria-label="Submitted Entries" class="mt-5">
    <h2 class="h5 text-center mb-4">Submitted Entries</h2>
    <ul class="list-unstyled" id="entryList">
      {% for item in entries %}
        {% set entry = item.entry %}
        <li class="mb-3 p-3 border rounded">
          <strong>{{ entry.game_title }}</strong> ‚Äî played on {{ entry.date_played }}<br>
          Submitted by
          <a href="{{ url_for('main.profile', user_id=entry.user.id) }}" class="fw-semibold">
            {{ entry.user.username }}
          </a>
          at {{ entry.timestamp.strftime('%Y-%m-%d %H:%M') }}<br>

          <!-- Like & Favorite -->
          <button
            type="button"
            class="like-btn {% if item.liked %}liked{% endif %}"
            data-entry-id="{{ entry.id }}"
          >
            üëç Like (<span class="like-count">{{ item.like_count or 0 }}</span>)
          </button>

          <button
            type="button"
            class="favorite-btn {% if item.favorited %}favorited{% endif %}"
            data-entry-id="{{ entry.id }}"
          >
            ‚≠ê Favorite (<span class="favorite-count">{{ item.favorite_count or 0 }}</span>)
          </button>

          <br>
          <a href="{{ url_for('main.view_entry', entry_id=entry.id) }}" class="d-inline-block mt-2">üí¨ View & Comment</a>

          {% if current_user.id == entry.user.id %}
            <form
              action="{{ url_for('main.delete_entry', entry_id=entry.id) }}"
              method="POST"
              class="d-inline-block"
            >
              <button
                type="submit"
                class="delete-btn"
                onclick="return confirm('Are you sure you want to delete this entry?')"
              >
                üóëÔ∏è Delete
              </button>
            </form>
          {% endif %}
        </li>
      {% endfor %}
    </ul>

    {% if pagination %}
      <nav class="pagination justify-content-center">
        <ul class="pagination">
          {% if pagination.has_prev %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('main.forum', page=1) }}">¬´ First</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="{{ url_for('main.forum', page=pagination.prev_num) }}">‚Äπ Prev</a>
            </li>
          {% endif %}

          {% for p in range(1, pagination.pages + 1) %}
            <li class="page-item {% if p == pagination.page %}active{% endif %}">
              <a class="page-link" href="{{ url_for('main.forum', page=p) }}">{{ p }}</a>
            </li>
          {% endfor %}

          {% if pagination.has_next %}
            <li class="page-item">
              <a class="page-link" href="{{ url_for('main.forum', page=pagination.next_num) }}">Next ‚Ä∫</a>
            </li>
            <li class="page-item">
              <a class="page-link" href="{{ url_for('main.forum', page=pagination.pages) }}">Last ¬ª</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block extra_scripts %}
  <!-- Bootstrap JS (ÂèØÈÄâÔºåÂ¶ÇÈúÄ‰ΩøÁî®Ê®°ÊÄÅÊ°Ü„ÄÅ‰∏ãÊãâËèúÂçïÁ≠âÁªÑ‰ª∂) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-Db3Gaa1OmjCtoqRcX+E9ZbAJlI0XxEoP0izTW0aC1FpO6D7hXQ8HK4bN0fZ82K1B"
    crossorigin="anonymous"
  ></script>

  <script src="{{ url_for('static', filename='js/forum.js') }}"></script>
  <script src="{{ url_for('static', filename='js/index.js') }}"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const visibilitySelect = document.getElementById('visibility');
      const friendSelection  = document.getElementById('friend-selection');

      function toggleFriendSelection () {
        friendSelection.style.display = visibilitySelect.value === 'friends' ? 'block' : 'none';
      }
      visibilitySelect.addEventListener('change', toggleFriendSelection);
      toggleFriendSelection(); // Initialize on load
    });
  </script>
{% endblock %}
