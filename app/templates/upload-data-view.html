{% extends "base.html" %}

{% block title %}Board Game Entry Analysis Tool{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/upload-data.css') }}">
{% endblock %}

{% block body_class %}upload-data-page{% endblock %}

{% block content %}
<h1>Board Game Entry Analysis Tool</h1>
<p>Please fill in the form below to record your board game session.</p>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <ul class="flashes">
      {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
      {% endfor %}
    </ul>
  {% endif %}
{% endwith %}

<!-- CSV Upload -->
<section class="file-upload">
  <h2>Import CSV into Form</h2>
  <input type="file" id="csvInput" accept=".csv" />
  <button type="button" id="loadCsvBtn">Load CSV to Form</button>
</section>

<!-- Manual Data Entry -->
<section aria-label="Manual Data Entry">
  <h2>Manual Data Entry</h2>
  <form id="entryForm" action="{{ url_for('main.forum') }}" method="POST">

    <!-- ÂèØËßÅÊÄßÈÄâÊã© -->
    <fieldset class="visibility-section">
      <legend>Who can see this entry?</legend>

      <div class="visibility-row">
        <label for="visibility" class="visibility-label">Visibility:</label>
        <select id="visibility" name="visibility" class="visibility-select">
          <option value="public">Everyone</option>
          <option value="friends">Only selected friends</option>
        </select>
      </div>

      <div id="friend-selection" class="friend-selection">
        {% if friends %}
          <p><strong>Select friends allowed to view:</strong></p>
          <div class="friend-checkboxes">
            {% for friend in friends %}
              <div class="friend-checkbox-row">
                <div class="checkbox-col">
                  <input type="checkbox" name="allowed_users" value="{{ friend.id }}">
                </div>
                <div class="label-col">{{ friend.username }}</div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p>You have no friends to share with.</p>
        {% endif %}
      </div>
    </fieldset>

    <!-- Ê∏∏ÊàèÂü∫Êú¨‰ø°ÊÅØ -->
    <label for="gameTitle">Game Title:</label>
    <input type="text" id="gameTitle" name="gameTitle" required placeholder="e.g., Go" />

    <label for="datePlayed">Date Played:</label>
    <input type="date" id="datePlayed" name="datePlayed" required />

    <!-- Áé©ÂÆ∂‰ø°ÊÅØ -->
    <div id="playersContainer">
      <fieldset class="player-info">
        <legend>Player 1</legend>
        <label for="player1Name">Name:</label>
        <input type="text" id="player1Name" name="player1Name" required placeholder="Player Name" />
        <label for="player1Username">Username (optional):</label>
        <input type="text" id="player1Username" name="player1Username" placeholder="Username" />
        <label><input type="checkbox" id="player1Win" name="player1Win"> Win?</label>
        <label><input type="checkbox" id="player1First" name="player1First"> Went First?</label>
        <label><input type="checkbox" id="player1FirstTime" name="player1FirstTime"> First Time Playing?</label>
        <label for="player1Score">Score:</label>
        <input type="number" id="player1Score" name="player1Score" placeholder="e.g., 30" />
      </fieldset>
    </div>

    <div id="playerButtons">
      <button type="button" id="addPlayerBtn">+ Add Another Player</button>
    </div>

    <div class="submit-buttons">
      <button type="submit">Submit Entry</button>
      <button type="submit">Submit and Share</button>
    </div>
  </form>
</section>

<!-- Submitted Entries -->
<section id="entryDisplay" aria-label="Submitted Entries" style="margin-top: 40px;">
  <h2>Submitted Entries</h2>
  <ul>
    {% for item in entries %}
      {% set entry = item.entry %}
      <li>
        <strong>{{ entry.game_title }}</strong> ‚Äî played on {{ entry.date_played }} <br>
        Submitted by 
        <a href="{{ url_for('main.profile', user_id=entry.user.id) }}">
          <em>{{ entry.user.username }}</em>
        </a> 
        at {{ entry.timestamp.strftime('%Y-%m-%d %H:%M') }}<br>

        <!-- Like and Favorite Buttons -->
        <button type="button" class="like-btn {% if item.liked %}liked{% endif %}" data-entry-id="{{ entry.id }}">
          üëç Like (<span class="like-count">{{ item.like_count or 0 }}</span>)
        </button>

        <button type="button" class="favorite-btn {% if item.favorited %}favorited{% endif %}" data-entry-id="{{ entry.id }}">
          ‚≠ê Favorite (<span class="favorite-count">{{ item.favorite_count or 0 }}</span>)
        </button>

        <br>
        <a href="{{ url_for('main.view_entry', entry_id=entry.id) }}">üí¨ View & Comment</a>

        {% if current_user.id == entry.user.id %}
          <form action="{{ url_for('main.delete_entry', entry_id=entry.id) }}" method="POST" style="display:inline;">
            <button type="submit" class="delete-btn" onclick="return confirm('Are you sure you want to delete this entry?')">
              üóëÔ∏è Delete
            </button>
          </form>
        {% endif %}
      </li>
    {% endfor %}
  </ul>

  {% if pagination %}
  <div class="pagination">
    {% if pagination.has_prev %}
      <a href="{{ url_for('main.forum', page=1) }}">¬´ First</a>
      <a href="{{ url_for('main.forum', page=pagination.prev_num) }}">‚Äπ Prev</a>
    {% endif %}

    {% for p in range(1, pagination.pages + 1) %}
      {% if p == pagination.page %}
        <strong>{{ p }}</strong>
      {% else %}
        <a href="{{ url_for('main.forum', page=p) }}">{{ p }}</a>
      {% endif %}
    {% endfor %}

    {% if pagination.has_next %}
      <a href="{{ url_for('main.forum', page=pagination.next_num) }}">Next ‚Ä∫</a>
      <a href="{{ url_for('main.forum', page=pagination.pages) }}">Last ¬ª</a>
    {% endif %}
  </div>
  {% endif %}
</section>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/forum.js') }}"></script>
<script src="{{ url_for('static', filename='js/index.js') }}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const visibilitySelect = document.getElementById('visibility');
    const friendSelection = document.getElementById('friend-selection');

    function toggleFriendSelection() {
      if (visibilitySelect.value === 'friends') {
        friendSelection.style.display = 'block';
      } else {
        friendSelection.style.display = 'none';
      }
    }

    visibilitySelect.addEventListener('change', toggleFriendSelection);
    toggleFriendSelection(); // Initialize on load
  });
</script>
{% endblock %}
